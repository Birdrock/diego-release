#!/bin/bash

scripts_path=./$(dirname $0)
eval $($scripts_path/get_paths.sh)

set -e
wget https://github.com/nats-io/nats-server/releases/download/v2.1.2/nats-server-v2.1.2-linux-amd64.zip
unzip -oj nats-server-v2.1.2-linux-amd64.zip nats-server-v2.1.2-linux-amd64/nats-server
rm nats-server-v2.1.2-linux-amd64.zip
mkdir -p "$GOPATH/bin"
mv nats-server "$GOPATH/bin/nats-server"
set +e

ERROR_CODE=0

SQL_FLAVOR=mysql $scripts_path/run-unit-tests-with-backing-store
ERROR_CODE=$?

SQL_FLAVOR=postgres $scripts_path/run-unit-tests-with-backing-store
let ERROR_CODE+=$?

$scripts_path/run-unit-tests-no-backing-store
let ERROR_CODE+=$?

if [ ${ERROR_CODE} -eq 0 ]; then
  echo "Diego Unit Tests Passed."
else
  echo "Diego Unit Tests Failed!"
fi

exit ${ERROR_CODE}
